<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0;
            padding: 0;
            background-color: #f5f5f7;
            color: #333;
            line-height: 1.6;
        }

        h1 {
            text-align: center;
            margin-top: 20px;
            color: #1d1d1f;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .input-with-button {
            display: flex;
            align-items: center;
            margin-bottom: 15px; /* Adjust margin to fit button */
        }

        .input-with-button input {
            margin-bottom: 0; /* Remove default input margin-bottom */
            flex-grow: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .input-with-button button {
            padding: 10px 15px;
            margin-left: -1px; /* Overlap border */
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border: 1px solid #0071e3; /* Match input border */
            background-color: #0071e3;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        .input-with-button button:hover {
            background-color: #005bb5;
        }


        .buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button.long {
            background-color: #006834;
            color: white;
        }

        button.long:hover {
            background-color: #005bb5;
        }

        button.short {
            background-color: #d70040;
            color: white;
        }

        button.short:hover {
            background-color: #a60030;
        }

        button.option, button.invest { /* Added .invest class */
            background-color: #0071e3;
            color: white;
        }

        button.undo {
            background-color: #646464;
            color: rgb(255, 255, 255);
            border: 1px solid #ccc;
        }

        button:active {
            transform: scale(0.98);
        }

        .output, .history, .transfer-history-section, .invest-history-section { /* Added .invest-history-section */
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .history-text {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            padding: 10px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .history h2, .transfer-history-section h2, .invest-history-section h2 { /* Added .invest-history-section h2 */
            margin-top: 0;
            color: #1d1d1f;
        }

        .buttons button {
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .buttons {
                flex-direction: column;
                gap: 10px;
            }

            input {
                font-size: 14px;
            }

            button {
                font-size: 14px;
            }
        }

        /* Modal styling */
        #withdrawModal, #transferModal, #optionModal, #investModal { /* Added #investModal */
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 90%;
            max-width: 800px; /* Increased max-width for invest modal */
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translate(-50%, -60%);
        }
        #withdrawModal[style*="display: block;"],
        #transferModal[style*="display: block;"],
        #optionModal[style*="display: block;"],
        #investModal[style*="display: block;"] { /* Added #investModal display */
            opacity: 1;
            transform: translate(-50%, -50%);
        }

        #modalOverlay, #transferOverlay, #optionOverlay, #investOverlay { /* Added #investOverlay */
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .modal-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal-buttons button.confirm {
            background: #0071e3;
            color: white;
        }
        .modal-buttons button.cancel {
            background: #d70040;
            color: white;
        }

        .invest-section {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
            flex: 1; /* Allow sections to grow and shrink */
            margin: 0 10px; /* Space between sections */
        }
        .invest-section:first-child {
            margin-left: 0;
        }
        .invest-section:last-child {
            margin-right: 0;
        }
        .invest-section h4 {
            margin-top: 0;
            color: #1d1d1f;
        }

        .invest-sections-wrapper {
            display: flex; /* Arrange buy and sell horizontally */
            gap: 20px; /* Space between buy and sell sections */
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        @media (max-width: 768px) {
            .invest-sections-wrapper {
                flex-direction: column;
            }
            .invest-section {
                margin: 10px 0;
            }
        }
    </style>

    <script>
        let cumulativeProfit = 0;
        let transactionHistory = [];
        let withdrawalHistory = [];
        let undoHistory = []; // Stores actions for undo
        let transferHistory = []; // Stores transfer actions
        let investmentPortfolio = {}; // Stores owned crypto tokens and their quantities
        let investTransactionHistory = []; // Stores buy/sell history for Invest feature
        let totalInvestmentCapital = 0; // New variable to track total investment capital

        function calculateProfit(type) {
            const usdtInvested = parseFloat(document.getElementById("usdtInvested").value);
            const leverage = parseInt(document.getElementById("leverage").value);
            const startDay = parseInt(document.getElementById("startDay").value);
            const startMonth = parseInt(document.getElementById("startMonth").value);
            const endDay = parseInt(document.getElementById("endDay").value);
            const endMonth = parseInt(document.getElementById("endMonth").value);
            const startPosition = parseFloat(document.getElementById("startPosition").value);
            const endPosition = parseFloat(document.getElementById("endPosition").value);
            const token = document.getElementById("token").value.trim();

            if (isNaN(usdtInvested) || isNaN(leverage) || isNaN(startDay) || isNaN(startMonth) || 
                isNaN(endDay) || isNaN(endMonth) || isNaN(startPosition) || isNaN(endPosition) || !token) {
                alert("Please ensure all inputs are valid and filled correctly.");
                return;
            }

            const totalInvestment = usdtInvested * leverage;
            const totalTokens = totalInvestment / startPosition;
            const daysDifference = Math.ceil(
                new Date(2024, endMonth - 1, endDay) - new Date(2024, startMonth - 1, startDay)
            ) / (1000 * 60 * 60 * 24) + 1;

            let profit;
            let risk;
            let positionInfo = `${formatNumber(startPosition)} - ${formatNumber(endPosition)}`;

            if (type === 'long') {
                profit = ((totalTokens * endPosition) - totalInvestment) - 
                    ((totalInvestment - usdtInvested) * 0.0001885392 * daysDifference);
                risk = (totalInvestment - usdtInvested) / totalTokens;
            } else { // type === 'short'
                const borrowedAmount = ((totalInvestment - usdtInvested) / startPosition) * 0.00015 * daysDifference * endPosition;
                profit = (totalInvestment - (totalTokens * endPosition)) - borrowedAmount;
                risk = (totalInvestment + usdtInvested) / totalTokens;
            }

            if (transactionHistory.length === 0 && cumulativeProfit === 0) { // Only initialize on first transaction if starting from 0
                cumulativeProfit = usdtInvested; 
            }
            
            cumulativeProfit += profit; 

            document.getElementById("riskValue").innerText = formatNumber(risk);

            const currentDate = new Date(2024, endMonth - 1, endDay);
            const newTransaction = { date: currentDate, profit, cumulativeProfit, totalInvestment, totalTokens, token, type, positionInfo };
            
            undoHistory.push({ action: 'add', transaction: newTransaction }); // Push to undo history
            transactionHistory.push(newTransaction);

            document.getElementById("cumulativeProfit").innerText = `$${Math.round(cumulativeProfit).toLocaleString()}`;

            updateVolume30Days(currentDate);
            updateHistory(); // Ensure history is updated after each calculation
        }

        function updateVolume30Days(latestDate) {
            const thirtyDaysAgo = new Date(latestDate);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const filteredTransactions = transactionHistory.filter(tx => tx.date >= thirtyDaysAgo && tx.date <= latestDate);
            const volume30Days = filteredTransactions.reduce((sum, tx) => sum + tx.totalInvestment, 0);
            
            document.getElementById("volume30Days").innerText = `$${Math.round(volume30Days).toLocaleString()}`;
            // The 'mainTotalTokens' is updated by updateMainTokensDisplay, not this function.
        }

        function updateHistory() {
            const historyElement = document.getElementById("historyText");
            historyElement.innerHTML = "";

            transactionHistory.forEach(tx => {
                const date = `${tx.date.getDate()}-${tx.date.getMonth() + 1}`;
                const cumulativeProfitText = `$${Math.round(tx.cumulativeProfit).toLocaleString()}`;
                historyElement.innerHTML += `<div>Token: ${tx.token || "N/A"}, Date: ${date}, Type: ${tx.type ? tx.type.toUpperCase() : 'N/A'}, Position: [${tx.positionInfo || 'N/A'}], Profit: $${Math.round(tx.profit).toLocaleString()}, Cumulative Profit: ${cumulativeProfitText}</div>`;
            });
        }

        function confirmWithdraw() {
            const amount = parseFloat(document.getElementById("modalWithdrawAmount").value);
            const withdrawDay = parseInt(document.getElementById("modalWithdrawDay").value);
            const withdrawMonth = parseInt(document.getElementById("modalWithdrawMonth").value);
            const exchangeRate = parseFloat(document.getElementById("exchangeRate").value) || 25500; // Default exchange rate

            if (isNaN(amount) || isNaN(withdrawDay) || isNaN(withdrawMonth)) {
                alert("Please ensure all inputs are valid and filled correctly.");
                return;
            }

            if (amount > cumulativeProfit) {
                alert("Amount exceeds cumulative profit.");
                return;
            }

            cumulativeProfit -= amount;
            const vndEquivalent = amount * exchangeRate;
            const newWithdrawal = { date: `${withdrawDay}-${withdrawMonth}`, amount, vndEquivalent, exchangeRate };
            undoHistory.push({ action: 'withdraw', withdrawal: newWithdrawal }); // Push to undo history
            withdrawalHistory.push(newWithdrawal);

            document.getElementById("cumulativeProfit").innerText = `$${Math.round(cumulativeProfit).toLocaleString()}`;
            updateWithdrawHistory();
            closeModal();
        }

        function updateWithdrawHistory() {
            const withdrawElement = document.getElementById("withdrawHistoryText");
            withdrawElement.innerHTML = "";  

            let totalWithdrawn = 0;  
            let totalVndEquivalent = 0;

            withdrawalHistory.forEach(wd => {
                totalWithdrawn += wd.amount;
                totalVndEquivalent += wd.vndEquivalent; 
                withdrawElement.innerHTML += `<div>Date: ${wd.date}, Amount: $${formatNumber(wd.amount)} (Rate: ${formatNumber(wd.exchangeRate)} VND/USD ~${formatNumber(wd.vndEquivalent)} VND)</div>`; // Display exchange rate
            });

            const totalText = `<h3>Total Withdrawn: $${Math.round(totalWithdrawn).toLocaleString()} (~${Math.round(totalVndEquivalent).toLocaleString()} VND)</h3>`;
            withdrawElement.innerHTML = totalText + withdrawElement.innerHTML;
        }
        
        function openTransferModal() {
            closeOptionModal();
            document.getElementById("transferModal").style.display = "block";
            document.getElementById("transferOverlay").style.display = "block";
            // No need to update transfer history inside modal initially, it's a separate section now
        }

        function closeTransferModal() {
            document.getElementById("transferModal").style.display = "none";
            document.getElementById("transferOverlay").style.display = "none";
        }

        function confirmTransfer() {
            const amount = parseFloat(document.getElementById("transferAmount").value);
            const transferDay = parseInt(document.getElementById("transferDay").value);
            const transferMonth = parseInt(document.getElementById("transferMonth").value);

            if (isNaN(amount) || isNaN(transferDay) || isNaN(transferMonth)) {
                alert("Please ensure all inputs are valid and filled correctly.");
                return;
            }

            if (amount > cumulativeProfit) {
                alert("Amount exceeds cumulative profit.");
                return;
            }

            cumulativeProfit -= amount;

            const newTransfer = { date: `${transferDay}-${transferMonth}`, amount };
            transferHistory.push(newTransfer);
            undoHistory.push({ action: 'transfer', transfer: newTransfer }); // Push to undo history

            document.getElementById("cumulativeProfit").innerText = `$${Math.round(cumulativeProfit).toLocaleString()}`;
            updateTransferHistory(); // Update the main transfer history section
            closeTransferModal(); // Close modal after successful transfer
        }

        function updateTransferHistory() {
            const transferElement = document.getElementById("transferHistoryTextSection"); // Updated ID for the main section
            transferElement.innerHTML = "";

            if (transferHistory.length === 0) {
                transferElement.innerHTML = "<div>No transfer history available.</div>";
                return;
            }

            transferHistory.forEach(tx => {
                transferElement.innerHTML += `<div>Date: ${tx.date}, Amount: $${Math.round(tx.amount).toLocaleString()}</div>`;
            });
        }

        // New Invest Feature Functions
        function openInvestModal() {
            document.getElementById("investModal").style.display = "block";
            document.getElementById("investOverlay").style.display = "block";
            updateInvestmentPortfolioDisplay(); // Update portfolio when modal opens
            updateInvestHistory(); // Update history when modal opens
            updateCalculatedTokens(); // Ensure initial calculation on opening
        }

        function closeInvestModal() {
            document.getElementById("investModal").style.display = "none";
            document.getElementById("investOverlay").style.display = "none";
        }

        function updateCalculatedTokens() {
            const cryptoBuyAmount = parseFloat(document.getElementById("cryptoBuyAmount").value);
            const buyPrice = parseFloat(document.getElementById("buyPrice").value);
            const calculatedTokensElement = document.getElementById("calculatedTokens");

            if (!isNaN(cryptoBuyAmount) && !isNaN(buyPrice) && buyPrice > 0) {
                const tokens = cryptoBuyAmount / buyPrice;
                calculatedTokensElement.innerText = `You will get: ${formatNumber(tokens)} tokens`;
            } else {
                calculatedTokensElement.innerText = "You will get: 0 tokens";
            }
        }

        function addInvestmentCapital() {
            const additionalAmount = parseFloat(document.getElementById("totalInvestedAmount").value);
            if (!isNaN(additionalAmount) && additionalAmount > 0) {
                totalInvestmentCapital += additionalAmount;
                const newInvestmentAction = {
                    type: 'add_capital',
                    amount: additionalAmount,
                    totalInvestmentCapitalSnapshot: totalInvestmentCapital
                };
                investTransactionHistory.push(newInvestmentAction);
                undoHistory.push({ action: 'invest_add_capital', transaction: newInvestmentAction });
                document.getElementById("totalInvestedAmount").value = ''; // Clear input after adding
                updateInvestmentPortfolioDisplay();
                updateInvestHistory();
            } else if (!isNaN(additionalAmount) && additionalAmount <= 0) {
                alert("Please enter a positive amount to add to investment capital.");
            }
        }

        function buyCrypto() {
            const cryptoBuyAmount = parseFloat(document.getElementById("cryptoBuyAmount").value);
            const cryptoName = document.getElementById("cryptoNameBuy").value.trim().toUpperCase();
            const buyPrice = parseFloat(document.getElementById("buyPrice").value);
            const buyDay = parseInt(document.getElementById("buyDay").value);
            const buyMonth = parseInt(document.getElementById("buyMonth").value);
            const buyYear = parseInt(document.getElementById("buyYear").value);

            if (isNaN(cryptoBuyAmount) || !cryptoName || isNaN(buyPrice) || isNaN(buyDay) || isNaN(buyMonth) || isNaN(buyYear)) {
                alert("Please fill in all buy crypto fields correctly.");
                return;
            }
            if (cryptoBuyAmount <= 0 || buyPrice <= 0) {
                alert("Amount and price must be positive.");
                return;
            }

            if (cryptoBuyAmount > totalInvestmentCapital) {
                alert("Cannot buy: Crypto buy amount exceeds available investment capital.");
                return;
            }
            
            totalInvestmentCapital -= cryptoBuyAmount;

            const tokensBought = cryptoBuyAmount / buyPrice;

            if (investmentPortfolio[cryptoName]) {
                investmentPortfolio[cryptoName] += tokensBought;
            } else {
                investmentPortfolio[cryptoName] = tokensBought;
            }

            const newBuyTransaction = {
                type: 'buy',
                date: `${buyDay}-${buyMonth}-${buyYear}`,
                cryptoName: cryptoName,
                buyPrice: buyPrice,
                cryptoBuyAmount: cryptoBuyAmount,
                tokens: tokensBought,
                totalInvestmentCapitalSnapshot: totalInvestmentCapital // Snapshot for undo
            };
            investTransactionHistory.push(newBuyTransaction);
            undoHistory.push({ action: 'invest_buy', transaction: newBuyTransaction });

            updateInvestmentPortfolioDisplay();
            updateInvestHistory();
            clearBuyInputs();
        }

        function sellCrypto() {
            const cryptoName = document.getElementById("cryptoNameSell").value.trim().toUpperCase();
            const sellTokens = parseFloat(document.getElementById("sellTokens").value);
            const sellPrice = parseFloat(document.getElementById("sellPrice").value);
            const sellDay = parseInt(document.getElementById("sellDay").value);
            const sellMonth = parseInt(document.getElementById("sellMonth").value);
            const sellYear = parseInt(document.getElementById("sellYear").value);

            if (!cryptoName || isNaN(sellTokens) || isNaN(sellPrice) || isNaN(sellDay) || isNaN(sellMonth) || isNaN(sellYear)) {
                alert("Please fill in all sell crypto fields correctly.");
                return;
            }
            if (sellTokens <= 0 || sellPrice <= 0) {
                alert("Amount and price must be positive.");
                return;
            }

            if (!investmentPortfolio[cryptoName] || investmentPortfolio[cryptoName] < sellTokens) {
                alert(`You do not have enough ${cryptoName} tokens to sell.`);
                return;
            }

            investmentPortfolio[cryptoName] -= sellTokens;
            if (investmentPortfolio[cryptoName] < 0.000001) { // Remove if negligible amount left
                delete investmentPortfolio[cryptoName];
            }

            const amountReceivedFromSell = sellTokens * sellPrice;
            totalInvestmentCapital += amountReceivedFromSell; // Add received amount to total investment capital

            const newSellTransaction = {
                type: 'sell',
                date: `${sellDay}-${sellMonth}-${sellYear}`,
                cryptoName: cryptoName,
                sellPrice: sellPrice,
                tokens: sellTokens,
                amountReceived: amountReceivedFromSell, // Renamed from profit for clarity in sell context
                totalInvestmentCapitalSnapshot: totalInvestmentCapital // Snapshot for undo
            };
            investTransactionHistory.push(newSellTransaction);
            undoHistory.push({ action: 'invest_sell', transaction: newSellTransaction });

            updateInvestmentPortfolioDisplay();
            updateInvestHistory();
            clearSellInputs();
        }

        function updateCalculatedSellAmount() {
            const sellTokens = parseFloat(document.getElementById("sellTokens").value);
            const sellPrice = parseFloat(document.getElementById("sellPrice").value);
            const calculatedSellAmountElement = document.getElementById("calculatedSellAmount");

            if (!isNaN(sellTokens) && !isNaN(sellPrice) && sellTokens > 0 && sellPrice > 0) {
                const amount = sellTokens * sellPrice;
                calculatedSellAmountElement.innerText = `You will get: $${formatNumber(amount)}`;
            } else {
                calculatedSellAmountElement.innerText = "You will get: $0";
            }
        }      

        function fillAllTokensToSell() {
            const cryptoName = document.getElementById("cryptoNameSell").value.trim().toUpperCase();
            if (cryptoName && investmentPortfolio[cryptoName]) {
                document.getElementById("sellTokens").value = investmentPortfolio[cryptoName];
            } else {
                alert("Please enter a valid Crypto Name to sell or you don't own any of this crypto.");
            }
        }


        function updateInvestmentPortfolioDisplay() {
            const portfolioElement = document.getElementById("totalAsset");
            portfolioElement.innerHTML = `<h4>Total Investment Capital: $${Math.round(totalInvestmentCapital).toLocaleString()}</h4>`; // Display total investment capital

            let hasAssets = false;
            for (const crypto in investmentPortfolio) {
                if (investmentPortfolio[crypto] > 0) {
                    portfolioElement.innerHTML += `<div>${crypto}: ${formatNumber(investmentPortfolio[crypto])} tokens</div>`;
                    hasAssets = true;
                }
            }
            if (!hasAssets && totalInvestmentCapital === 0) { // If no assets and capital is 0, show a specific message
                portfolioElement.innerHTML = `<h4>Total Investment Capital: $0</h4><div>No crypto assets owned.</div>`;
            } else if (!hasAssets && totalInvestmentCapital > 0) { // If capital > 0 but no assets, display capital and no assets msg
                portfolioElement.innerHTML = `<h4>Total Investment Capital: $${Math.round(totalInvestmentCapital).toLocaleString()}</h4><div>No crypto assets owned.</div>`;
            }
        }


        function updateInvestHistory() {
            const investHistoryElement = document.getElementById("investTransactionHistory");
            investHistoryElement.innerHTML = "";

            if (investTransactionHistory.length === 0) {
                investHistoryElement.innerHTML = "<div>No investment transactions yet.</div>";
                return;
            }

            investTransactionHistory.forEach(tx => {
                if (tx.type === 'buy') {
                    investHistoryElement.innerHTML += `<div>Date: ${tx.date}, BUY ${tx.cryptoName}: ${formatNumber(tx.tokens)} tokens at $${formatNumber(tx.buyPrice)} (Spent: $${formatNumber(tx.cryptoBuyAmount)})</div>`;
                } else if (tx.type === 'sell') {
                    investHistoryElement.innerHTML += `<div>Date: ${tx.date}, SELL ${tx.cryptoName}: ${formatNumber(tx.tokens)} tokens at $${formatNumber(tx.sellPrice)} (Received: $${formatNumber(tx.amountReceived)})</div>`;
                } else if (tx.type === 'add_capital') {
                    investHistoryElement.innerHTML += `<div>Date: (N/A), Added Investment Capital: $${formatNumber(tx.amount)}</div>`;
                }
            });
        }

        function clearBuyInputs() {
            document.getElementById("cryptoBuyAmount").value = '';
            document.getElementById("cryptoNameBuy").value = '';
            document.getElementById("buyPrice").value = '';
            document.getElementById("buyDay").value = '';
            document.getElementById("buyMonth").value = '';
            document.getElementById("buyYear").value = '';
            document.getElementById("calculatedTokens").innerText = "You will get: 0 tokens"; // Clear calculated tokens
        }

        function clearSellInputs() {
            document.getElementById("cryptoNameSell").value = '';
            document.getElementById("sellTokens").value = '';
            document.getElementById("sellPrice").value = '';
            document.getElementById("sellDay").value = '';
            document.getElementById("sellMonth").value = '';
            document.getElementById("sellYear").value = '';
            document.getElementById("calculatedSellAmount").innerText = "You will get: $0";
        }

        function undo() {
            const lastAction = undoHistory.pop();
            if (!lastAction) {
                alert("No actions to undo.");
                return;
            }

            if (lastAction.action === 'add') { // Undo Long/Short profit calculation
                const { transaction } = lastAction;
                transactionHistory = transactionHistory.filter(tx => tx !== transaction);
                cumulativeProfit = transaction.cumulativeProfit - transaction.profit; 
                if (transactionHistory.length === 0 && cumulativeProfit === transaction.totalInvestment) {
                    cumulativeProfit = 0;
                }
                const latestDate = transactionHistory.length > 0 ? transactionHistory[transactionHistory.length - 1].date : new Date();
                updateVolume30Days(latestDate);
            } else if (lastAction.action === 'withdraw') { // Undo withdrawal
                const { withdrawal } = lastAction;
                withdrawalHistory = withdrawalHistory.filter(wd => wd !== withdrawal);
                cumulativeProfit += withdrawal.amount;
            } else if (lastAction.action === 'transfer') { // Undo transfer
                const { transfer } = lastAction;
                transferHistory = transferHistory.filter(tr => tr !== transfer);
                cumulativeProfit += transfer.amount;
            } else if (lastAction.action === 'invest_buy') { // Undo crypto buy
                const { transaction } = lastAction;
                investTransactionHistory = investTransactionHistory.filter(tx => tx !== transaction);
                totalInvestmentCapital += transaction.cryptoBuyAmount; // Return spent amount to total investment capital

                if (investmentPortfolio[transaction.cryptoName]) {
                    investmentPortfolio[transaction.cryptoName] += transaction.tokens;
                    if (investmentPortfolio[transaction.cryptoName] < 0.000001) { 
                        delete investmentPortfolio[transaction.cryptoName];
                    }
                }
            } else if (lastAction.action === 'invest_sell') { // Undo crypto sell
                const { transaction } = lastAction;
                investTransactionHistory = investTransactionHistory.filter(tx => tx !== transaction);
                totalInvestmentCapital -= transaction.amountReceived; // Deduct received amount from total investment capital

                if (investmentPortfolio[transaction.cryptoName]) {
                    investmentPortfolio[transaction.cryptoName] += transaction.tokens;
                } else {
                    investmentPortfolio[transaction.cryptoName] = transaction.tokens;
                }
            } else if (lastAction.action === 'invest_add_capital') { // Undo adding investment capital
                const { transaction } = lastAction;
                investTransactionHistory = investTransactionHistory.filter(tx => tx !== transaction);
                totalInvestmentCapital -= transaction.amount; // Deduct the added amount
            }

            document.getElementById("cumulativeProfit").innerText = `$${Math.round(cumulativeProfit).toLocaleString()}`;
            updateHistory();
            updateWithdrawHistory();
            updateTransferHistory(); // Update transfer history section
            updateInvestmentPortfolioDisplay(); // Update investment portfolio
            updateInvestHistory(); // Update invest transaction history
            updateMainTokensDisplay(); // Update main tokens display in case undo affected inputs
        }

        function openModal() { // For Withdraw Modal
            closeOptionModal();
            document.getElementById("withdrawModal").style.display = "block";
            document.getElementById("modalOverlay").style.display = "block";
        }

        function closeModal() { // For Withdraw Modal
            closeOptionModal();
            document.getElementById("withdrawModal").style.display = "none";
            document.getElementById("modalOverlay").style.display = "none";
        }

        function openOptionModal() {
            document.getElementById("optionModal").style.display = "block";
            document.getElementById("optionOverlay").style.display = "block";
        }

        function closeOptionModal() {
            document.getElementById("optionModal").style.display = "none";
            document.getElementById("optionOverlay").style.display = "none";
        }

        // Function to update the "Tokens" display in the main profit calculator section
        function updateMainTokensDisplay() {
            const usdtInvested = parseFloat(document.getElementById("usdtInvested").value);
            const leverage = parseFloat(document.getElementById("leverage").value);
            const startPosition = parseFloat(document.getElementById("startPosition").value);

            if (!isNaN(usdtInvested) && !isNaN(leverage) && !isNaN(startPosition) && startPosition > 0) {
                const totalInvestment = usdtInvested * leverage;
                const totalTokens = totalInvestment / startPosition;
                document.getElementById("mainTotalTokens").innerText = `${formatNumber(totalTokens)} tokens`;
            } else {
                document.getElementById("mainTotalTokens").innerText = "0 tokens";
            }
        }
        
        document.addEventListener("keydown", function (event) {
            const activeModal = document.querySelector("div[style*='display: block']"); 
            if (!activeModal) return;

            if (event.key === "Enter") {
                let confirmButton;

                switch (activeModal.id) {
                    case "withdrawModal":
                        confirmButton = activeModal.querySelector("button[onclick*='confirmWithdraw']");
                        break;
                    case "transferModal":
                        confirmButton = activeModal.querySelector("button[onclick*='confirmTransfer']");
                        break;
                    case "investModal":
                        // Prioritize "Add Investment Capital" if that input is focused
                        if (document.activeElement.id === "totalInvestedAmount") {
                            confirmButton = document.getElementById("addCapitalButton");
                        } else if (document.activeElement.closest('.invest-section') && document.activeElement.closest('.invest-section').querySelector('h4').innerText.includes('Buy')) {
                            confirmButton = document.getElementById("buyCryptoButton");
                        } else if (document.activeElement.closest('.invest-section') && document.activeElement.closest('.invest-section').querySelector('h4').innerText.includes('Sell')) {
                            confirmButton = document.getElementById("sellCryptoButton");
                        } else {
                            // Default to buy if no specific focus or multiple fields are active
                            confirmButton = document.getElementById("buyCryptoButton");
                        }
                        break;
                    default:
                        confirmButton = activeModal.querySelector("button.confirm");
                        break;
                }

                if (confirmButton) confirmButton.click();
            }

            if (event.key === "Escape") {
                switch (activeModal.id) {
                    case "withdrawModal":
                        closeModal();
                        break;
                    case "transferModal":
                        closeTransferModal();
                        break;
                    case "optionModal":
                        closeOptionModal();
                        break;
                    case "investModal":
                        closeInvestModal();
                        break;
                    default:
                        const closeButton = activeModal.querySelector("button[onclick*='close']");
                        if (closeButton) closeButton.click();
                        break;
                }
            }
        });

        function formatNumber(value) {
            if (Number.isInteger(value)) {
                return value.toLocaleString(); 
            } else {
                return value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
            }
        }

        // Initialize history sections on load
        document.addEventListener('DOMContentLoaded', () => {
            updateWithdrawHistory();
            updateTransferHistory();
            updateInvestmentPortfolioDisplay(); // Initialize portfolio display
            updateInvestHistory(); // Initialize invest history display
            updateMainTokensDisplay(); // Initialize main tokens display
        });

    </script>

</head>
<body>
    <div id="withdrawModal">
        <h3>Withdraw Funds</h3>
        <label for="modalWithdrawAmount">Withdraw Amount:</label>
        <input type="number" id="modalWithdrawAmount">

        <label for="exchangeRate">Exchange Rate (VND/USD):</label>
        <input type="number" id="exchangeRate" value="25500"> <label>Withdraw Date:</label>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="modalWithdrawDay" placeholder="Day" style="width: 50%;">
            <input type="number" id="modalWithdrawMonth" placeholder="Month" style="width: 50%;">
        </div>

        <div class="modal-buttons">
            <button onclick="confirmWithdraw()" class="confirm">Confirm</button>
            <button onclick="closeModal()" class="cancel">Cancel</button>
        </div>
        <h4 style="margin-top: 20px;">Withdraw History</h4>
        <div id="withdrawHistoryText" class="history-text"></div>
    </div>
    <div id="modalOverlay" onclick="closeModal()"></div>

    <div id="transferModal">
        <h3>Transfer Funds</h3>
        <label for="transferAmount">Transfer Amount:</label>
        <input type="number" id="transferAmount" placeholder="Amount">

        <label>Transfer Date:</label>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="transferDay" placeholder="Day" style="width: 50%;">
            <input type="number" id="transferMonth" placeholder="Month" style="width: 50%;">
        </div>

        <div class="modal-buttons">
            <button onclick="confirmTransfer()" class="confirm">Confirm</button>
            <button onclick="closeTransferModal()" class="cancel">Cancel</button>
        </div>
    </div>
    <div id="transferOverlay" onclick="closeTransferModal()"></div>

    <div id="optionModal">
        <h3>Choose Option</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button onclick="openModal()" class="option">Withdraw</button>
            <button onclick="openTransferModal()" class="option">Transfer</button>
            </div>
        <div class="modal-buttons">
            <button onclick="closeOptionModal()" class="cancel" style="width: 100%;">Cancel</button>
        </div>
    </div>
    <div id="optionOverlay" onclick="closeOptionModal()"></div>

    <div id="investModal">
        <h3>Invest in Crypto</h3>
        
        <div class="invest-sections-wrapper">
            <div class="invest-section">
                <h4>Buy Crypto</h4>
                <label for="totalInvestedAmount">Add Investment Capital:</label>
                <input type="number" id="totalInvestedAmount" placeholder="e.g., 1000">
                <div class="modal-buttons">
                    <button onclick="addInvestmentCapital()" class="confirm" id="addCapitalButton">Add Capital</button>
                </div>

                <label for="cryptoBuyAmount">Amount to Buy Crypto ($):</label>
                <input type="number" id="cryptoBuyAmount" placeholder="e.g., 100" oninput="updateCalculatedTokens()">

                <label for="cryptoNameBuy">Crypto Name (e.g., BTC, ETH):</label>
                <input type="text" id="cryptoNameBuy" placeholder="e.g., BTC">

                <label for="buyPrice">Buy Price:</label>
                <input type="number" id="buyPrice" placeholder="e.g., 30000" oninput="updateCalculatedTokens()">
                <div id="calculatedTokens" style="margin-bottom: 15px; font-weight: bold;">You will get: 0 tokens</div>

                <label>Buy Date:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="buyDay" placeholder="Day" style="width: 33%;">
                    <input type="number" id="buyMonth" placeholder="Month" style="width: 33%;">
                    <input type="number" id="buyYear" placeholder="Year" style="width: 33%;">
                </div>
                <div class="modal-buttons">
                    <button onclick="buyCrypto()" class="confirm" id="buyCryptoButton">Buy</button>
                </div>
            </div>

            <div class="invest-section">
                <h4>Sell Crypto</h4>
                <label for="cryptoNameSell">Crypto Name to Sell:</label>
                <input type="text" id="cryptoNameSell" placeholder="e.g., BTC">

                <label for="sellTokens">Number of Tokens to Sell:</label>
                <div class="input-with-button">
                    <input type="number" id="sellTokens" placeholder="e.g., 0.003" oninput="updateCalculatedSellAmount()">
                    <button type="button" onclick="fillAllTokensToSell()">All</button>
                </div>

                <label for="sellPrice">Sell Price:</label>
                <input type="number" id="sellPrice" placeholder="e.g., 35000" oninput="updateCalculatedSellAmount()">
                <div id="calculatedSellAmount" style="margin-bottom: 15px; font-weight: bold;">You will get: $0</div>                

                <label>Sell Date:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="sellDay" placeholder="Day" style="width: 33%;">
                    <input type="number" id="sellMonth" placeholder="Month" style="width: 33%;">
                    <input type="number" id="sellYear" placeholder="Year" style="width: 33%;">
                </div>
                <div class="modal-buttons">
                    <button onclick="sellCrypto()" class="confirm" id="sellCryptoButton">Sell</button>
                </div>
            </div>
        </div>
        
        <h4 style="margin-top: 20px;">Total Crypto Assets & Capital</h4>
        <div id="totalAsset" class="history-text" style="height: auto; min-height: 50px;"></div>

        <h4 style="margin-top: 20px;">Investment Transaction History</h4>
        <div id="investTransactionHistory" class="history-text"></div>

        <div class="modal-buttons" style="margin-top: 20px;">
            <button onclick="closeInvestModal()" class="cancel" style="width: 100%;">Close</button>
        </div>
    </div>
    <div id="investOverlay" onclick="closeInvestModal()"></div>


    <h1>Profit Calculator</h1>
    <div class="container">
        <label for="leverage">Leverage:</label>
        <input type="number" id="leverage" value="5" oninput="updateMainTokensDisplay()">

        <label for="token">Token:</label>
        <input type="text" id="token">

        <label for="usdtInvested">USDT Invested:</label>
        <input type="number" id="usdtInvested" oninput="updateMainTokensDisplay()">

        <label>Position:</label>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="startPosition" placeholder="Start" style="width: 50%;" oninput="updateMainTokensDisplay()">
            <input type="number" id="endPosition" placeholder="End" style="width: 50%;">
        </div>        

        <label>Time Start:</label>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="startDay" placeholder="Day" style="width: 50%;">
            <input type="number" id="startMonth" placeholder="Month" style="width: 50%;">
        </div>

        <label>Time End:</label>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="endDay" placeholder="Day" style="width: 50%;">
            <input type="number" id="endMonth" placeholder="Month" style="width: 50%;">
        </div>

    </div>
    <div class="buttons">
        <button class="long" onclick="calculateProfit('long')">Long</button>
        <button class="short" onclick="calculateProfit('short')">Short</button>
        <button class="option" onclick="openOptionModal()">Option</button>
        <button class="invest" onclick="openInvestModal()">Invest</button> <button class="undo" onclick="undo()">Undo</button>

    </div>
    <div class="output">
        <div><strong>Cumulative Profit:</strong> <span id="cumulativeProfit" style="color: green;">$0</span></div>
        <div><strong>Volume 30 Days:</strong> <span id="volume30Days">$0</span></div>
        <div><strong>Tokens:</strong> <span id="mainTotalTokens">0</span></div> <div><strong>Risk:</strong> <span id="riskValue" style="color: red;">0.00</span></div>
    </div>
    <div class="history">
        <h2>Transaction History</h2>
        <div id="historyText" class="history-text"></div>
    </div>

    <div class="transfer-history-section">
        <h2>Transfer History</h2>
        <div id="transferHistoryTextSection" class="history-text"></div>
    </div>

    <div class="invest-history-section">
        <h2>Investment Portfolio & History</h2>
        <div id="totalAsset" class="history-text" style="height: auto; min-height: 50px;"></div>
        <div id="investTransactionHistory" class="history-text"></div>
    </div>

</body>
</html>